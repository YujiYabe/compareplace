<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title> compareplace</title>
	<link rel="shortcut icon" href="favicon.ico">
	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css?family=Roboto+Mono:100,300,400,500,700,900|Material+Icons">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vuetify/1.5.16/vuetify.css">
	<meta id="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

</head>

<body>
	<div id="app">
		<v-app>
			<v-content>

				<v-container fluid grid-list-md>

					<!-- title ------------------------------------------ -->
					<v-layout justify-center>
						<v-flex xs12>
							<div class="title_text display-4">
								<span class="text_red">compa</span><span class="text_perple">re</span><span
									class="text_blue">place</span>
							</div>
						</v-flex>
					</v-layout>

					<v-layout justify-center>
						<v-flex xs10>
							<br>
							置換後の結果はブラウザに保存されます。<br>
							ブラウザを更新すると続けて置換できます。
						</v-flex>
					</v-layout>


					<v-layout row wrap justify-center :class="{'sticky': dataPosition > 0}">
						<!-- switch mode ------------------------------------------ -->
						<v-flex xs5>
							<v-card flat id='mode1' :class="methodClassAplly(1)" v-on:click="methodChangeMode(1)">
								<v-card-text>正規表現なし置換</v-card-text>
							</v-card>
						</v-flex>
						<v-flex xs5>
							<v-card flat id='mode2' :class="methodClassAplly(2)" v-on:click="methodChangeMode(2)">
								<v-card-text>正規表現あり置換</v-card-text>
							</v-card>
						</v-flex>

						<!-- keyword area ------------------------------------------ -->
						<v-flex xs5>
							<v-textarea auto-grow :rows="dataKeywordRowHeight" v-on:keyup="methodControlReplace"
								id="idPreKeyword" v-model="dataPreKeyword" @click:append="methodPreKeywordRemove"
								append-icon="clear" v-on:keydown.tab.prevent="methodInsertTab"
								background-color="font_mono bg_pink_keyword" placeholder="置換前文字列" color="green">
							</v-textarea>
						</v-flex>
						<v-flex xs5>
							<v-textarea auto-grow :rows="dataKeywordRowHeight" v-on:keyup="methodControlReplace"
								id="idPosKeyword" v-model="dataPosKeyword" @click:append="methodPosKeywordRemove"
								append-icon="clear" v-on:keydown.tab.prevent="methodInsertTab"
								background-color="font_mono bg_aqua_keyword" placeholder="置換後文字列" color="yellow">
							</v-textarea>
						</v-flex>
						<!-- selectbox --------------------- -->
						<v-flex xs10>
							<v-select :items="dataKeywordList" v-model="dataSelectedList" item-text="summary"
								return-object @change="methodSelectPair" background-color="font_mono bg_perple"
								@click:prepend="methodDeleteKeywordPairList" prepend-icon="delete"
								@click:append-outer="methodAddKeywordPairList" append-outer-icon="add_box"></v-select>
						</v-flex>
					</v-layout>

					<!-- replace area ------------------------------------------ -->
					<v-layout row wrap justify-center class="z_index_txtBody">
						<v-flex xs5>
							<v-textarea :rows="dataTxtBodyRowHeight" auto-grow background-color="font_mono bg_pink"
								id="idPreTxtbody" v-model="dataPreTxtbody" placeholder="変更前テキスト"
								@click:append="methodTxtBodyRemove" append-icon="clear"
								v-on:keydown.tab.prevent="methodInsertTab"
								v-on:keyup="methodControlReplace" color="green">
							</v-textarea>
						</v-flex>
						<v-flex xs5>
							<v-textarea :rows="dataTxtBodyRowHeight" auto-grow background-color="font_mono bg_aqua"
								v-model="dataPosTxtbody" placeholder="変更後テキスト" readonly color="yellow">
							</v-textarea>
						</v-flex>
					</v-layout>

				</v-container>
			</v-content>
		</v-app>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vuetify/1.5.16/vuetify.js"></script>
	<link rel="stylesheet" href="compareplace-0.4.css">

	<script>
		const app1 = new Vue({
			el: '#app',
			data: {
				dataPosition: null,
				dataPreKeyword: '',
				dataPosKeyword: '',
				dataPreTxtbody: '',
				dataPosTxtbody: '',
				dataReplaceMode: 1,
				dataKeywordRowHeight: 2,
				dataTxtBodyRowHeight: 30,
				dataKeywordList: [],
				dataSelectedList: '',
			},
			mounted() {
				window.addEventListener('scroll', this.methodHandleScroll);

				//localstorage からデータ取り出し
				this.setDataPreKeyword(this.getLocalStorageDataPreKeyword());
				this.setDataPosKeyword(this.getLocalStorageDataPosKeyword());
				this.setDataPreTxtbody(this.getLocalStorageDataPreTxtbody());
				this.setDataReplaceMode(this.getLocalStorageDataReplaceMode());
				this.setDataKeywordList(this.getLocalStorageDataKeywordList());

				this.methodClickReplaceMode();
			},

			methods: {
				// マウント時のみ起動
				methodClickReplaceMode() {
					if (this.getDataReplaceMode() == 1) {
						document.getElementById("mode1").click();
					} else {
						document.getElementById("mode2").click();
					}
				},

				methodDeleteKeywordPairList() {

					const tempDataKeywordList = this.getDataKeywordList().filter(function (value) {
						if (
							value['pre'] == this.getDataPreKeyword() &&
							value['pos'] == this.getDataPosKeyword() &&
							value['mode'] == this.getDataReplaceMode()
						) {
							console.log("deleted : " + value['summary']);
						} else {
							return value;
						}
					})

					this.setDataKeywordList(tempDataKeywordList);
				},

				methodTxtBodyRemove() {
					this.setDataPreTxtbody("");
				},

				methodPreKeywordRemove() {
					this.setDataPreKeyword("");
				},

				methodPosKeywordRemove() {
					this.setDataPosKeyword("");
				},

				methodAddKeywordPairList() {
					const aliasMode = this.getDataReplaceMode() == 1 ? 'nrml =' : 'rglr =';
					const aliasPre = this.getDataPreKeyword().replace(/\r?\n/g, '↓').replace(/\t/g, '→');
					const aliasPos = this.getDataPosKeyword().replace(/\r?\n/g, '↓').replace(/\t/g, '→');
					const summary = aliasMode + '［' + aliasPre + '］⇔［' + aliasPos + '］';
					const pair = {
						"summary": summary,
						"mode": this.getDataReplaceMode(),
						"pre": this.getDataPreKeyword(),
						"pos": this.getDataPosKeyword(),
					};
					const dataKeywordList = this.getDataKeywordList();
					dataKeywordList.push(pair);
					this.setDataKeywordList(dataKeywordList);
				},

				methodSelectPair() {
					const dataSelectedList = this.getDataSelectedList();
					this.setDataReplaceMode(dataSelectedList['mode']);
					this.setDataPreKeyword(dataSelectedList['pre']);
					this.setDataPosKeyword(dataSelectedList['pos']);

					this.methodControlReplace();
				},

				methodHandleScroll() {
					this.setDataPosition(document.documentElement.scrollTop || document.body.scrollTop);
				},

				// methodInsertTab(target) {
				methodInsertTab(event) {
					alert(event.target.tagName)
					const tabchar = "\t"
					const obj = document.getElementById(target); // オブジェクト取得
					const sPos = obj.selectionStart;
					const ePos = obj.selectionEnd;
					const addStr = obj.value.substr(0, sPos) + tabchar + obj.value.substr(ePos);
					const cPos = sPos + tabchar.length;
					obj.value = addStr;

					switch (target) {
						case "idPreKeyword":
							this.setDataPreKeyword(addStr);
							break;
						case "idPosKeyword":
							this.setDataPosKeyword(addStr);
							break;
						case "idPreTxtbody":
							this.setDataPreTxtbody(addStr);
							break;
					}

					obj.setSelectionRange(cPos, cPos); // 文字選択状態を初期の状態へ  

				},

				methodControlReplace() {
					if (this.dataPreKeyword != "") {
						const dataPreKeyword = this.getDataPreKeyword();
						const dataPosKeyword = this.getDataPosKeyword();
						const dataPreTxtbody = this.getDataPreTxtbody();

						const dataReplaceMode = this.getDataReplaceMode();
						let dataPosTxtbody = "";
						switch (dataReplaceMode) {
							case 1:
								dataPosTxtbody = dataPreTxtbody.split(dataPreKeyword).join(dataPosKeyword);
								break;
							case 2:
								dataPosTxtbody = dataPreTxtbody.replace(new RegExp(dataPreKeyword, "g"),
									dataPosKeyword);
								break;
						}
						this.setDataPosTxtbody(dataPosTxtbody);
						this.setLocalStorageDataPreKeyword(dataPreKeyword);
						this.setLocalStorageDataPosKeyword(dataPosKeyword);

						// 置換後に置換済みテキストを置換前テキストとして保存
						this.setLocalStorageDataPreTxtbody(dataPosTxtbody);
					}
				},

				methodClassAplly(select) {
					const one = select;
					const two = this.getDataReplaceMode();
					const applyColor = one === two ? "purple lighten-3" : "grey";
					return applyColor;
				},

				methodChangeMode(select) {
					this.setDataReplaceMode(select);
					this.methodControlReplace();
				},

				// getter _______________
				getDataPreKeyword() {
					return this.dataPreKeyword;
				},
				getDataPosKeyword() {
					return this.dataPosKeyword;
				},

				getDataReplaceMode() {
					return this.dataReplaceMode;
				},

				getDataKeywordList() {
					return this.dataKeywordList;
				},

				getDataSelectedList() {
					return this.dataSelectedList;
				},

				getDataPreTxtbody() {
					return this.dataPreTxtbody;
				},

				getLocalStorageDataPreKeyword() {
					return localStorage.getItem("dataPreKeyword") || "";
				},

				getLocalStorageDataPosKeyword() {
					return localStorage.getItem("dataPosKeyword") || "";
				},

				getLocalStorageDataPreTxtbody() {
					return localStorage.getItem("dataPreTxtbody") || "";
				},

				getLocalStorageDataReplaceMode() {
					return localStorage.getItem("dataReplaceMode") || 1;
				},

				getLocalStorageDataKeywordList() {
					return JSON.parse(localStorage.getItem("dataKeywordList")) || [];
				},



				// setter _______________
				setDataPreKeyword(context) {
					this.dataPreKeyword = context;
					this.setLocalStorageDataPreKeyword(context);
				},
				setDataPosKeyword(context) {
					this.dataPosKeyword = context;
					this.setLocalStorageDataPosKeyword(context);
				},
				setDataPreTxtbody(context) {
					this.dataPreTxtbody = context;
					this.setLocalStorageDataPreTxtbody(context);
				},

				setDataPosTxtbody(context) {
					this.dataPosTxtbody = context;
				},

				setDataReplaceMode(context) {
					this.dataReplaceMode = context;
					this.setLocalStorageDataReplaceMode(context);
				},
				setDataKeywordList(context) {
					this.dataKeywordList = context;
					this.setLocalStorageDataKeywordList(JSON.stringify(context));
				},
				setDataPosition(context) {
					this.dataPosition = context;
				},

				setLocalStorageDataPreKeyword(context) {
					localStorage.setItem("dataPreKeyword", context);
				},

				setLocalStorageDataPosKeyword(context) {
					localStorage.setItem("dataPosKeyword", context);
				},

				setLocalStorageDataPreTxtbody(context) {
					localStorage.setItem("dataPreTxtbody", context);
				},

				setLocalStorageDataReplaceMode(context) {
					localStorage.setItem("dataReplaceMode", context);
				},

				setLocalStorageDataKeywordList(context) {
					localStorage.setItem("dataKeywordList", context);
				},


			}
		})
	</script>
</body>

</html>